import * as faceapi from "face-api.js"
import './style.css'

const GROUND_TRUTH = [
    new faceapi.LabeledFaceDescriptors(
        'F',
        [new Float32Array([-0.1793300211429596, 0.08565361797809601, 0.016897428780794144, 0.04353418946266174, -0.17107586562633514, -0.047660376876592636, 0.03277411311864853, -0.059660669416189194, 0.12901830673217773, -0.06870682537555695, 0.16546183824539185, -0.05192521959543228, -0.19282282888889313, -0.0045562260784208775, -0.03963024169206619, 0.0855756476521492, -0.0952833816409111, -0.1923423707485199, -0.12537060678005219, -0.13864019513130188, -0.009306727908551693, 0.03307802975177765, 0.003189962822943926, 0.10681445151567459, -0.12743841111660004, -0.3252268135547638, -0.08206711709499359, -0.08683197945356369, 0.18684032559394836, -0.08558381348848343, 0.05683969333767891, 0.025875438004732132, -0.11045091599225998, -0.03893706575036049, 0.0400463230907917, 0.07002092897891998, -0.034162648022174835, -0.023432353511452675, 0.3108651041984558, -0.04351218789815903, -0.2082768976688385, 0.045717135071754456, 0.03276602923870087, 0.396776407957077, 0.1354788839817047, 0.04662415385246277, 0.03685382008552551, -0.02007114328444004, 0.12857283651828766, -0.1655709445476532, 0.09033709764480591, 0.16959601640701294, 0.12860624492168427, 0.019000830128788948, 0.08810754120349884, -0.12350756675004959, -0.025936564430594444, 0.18029645085334778, -0.21043364703655243, 0.1030597910284996, 0.028869524598121643, -0.07022184878587723, -0.01122588012367487, -0.07759193331003189, 0.17076726257801056, 0.08119824528694153, -0.057973671704530716, -0.19214916229248047, 0.1388818323612213, -0.2617410123348236, -0.013179884292185307, 0.18264462053775787, -0.08696386963129044, -0.1325792521238327, -0.23189491033554077, 0.05931350216269493, 0.5017964243888855, 0.17778748273849487, -0.12743403017520905, 0.025784049183130264, 0.054169777780771255, -0.03604859113693237, 0.14885155856609344, 0.07466918975114822, -0.15256153047084808, -0.034825462847948074, -0.13528671860694885, 0.032785557210445404, 0.17767289280891418, 0.04384498670697212, -0.120821513235569, 0.11466220021247864, 0.08081358671188354, -0.007220889441668987, 0.06026361137628555, 0.013983707875013351, -0.13311421871185303, -0.037005599588155746, -0.0827534943819046, -0.0483354851603508, 0.04560791328549385, -0.004106280393898487, 0.05502701178193092, 0.02280663326382637, -0.07559119164943695, 0.17888778448104858, -0.026451269164681435, 0.021711599081754684, -0.08857181668281555, 0.09748797118663788, -0.10004083812236786, -0.004026402719318867, 0.1661611944437027, -0.24692632257938385, 0.162326380610466, 0.11285192519426346, -0.035798024386167526, 0.1457832008600235, 0.07274038344621658, 0.022872522473335266, -0.009350071661174297, 0.0307052880525589, -0.07210809737443924, -0.07925776392221451, 0.06108355149626732, -0.07599976658821106, 0.20066992938518524, 0.009220273233950138])]
    ),
    new faceapi.LabeledFaceDescriptors(
        'S',
        [new Float32Array([-0.1359163373708725, 0.016520574688911438, 0.0918012410402298, -0.06976153701543808, -0.14734221994876862, 0.018226753920316696, 0.0494253970682621, -0.017509646713733673, 0.11306923627853394, -0.12685856223106384, 0.19190716743469238, -0.002917057368904352, -0.24704690277576447, 0.017993547022342682, -0.049596916884183884, 0.1585332453250885, -0.1583496779203415, -0.15876641869544983, -0.10978573560714722, -0.098827064037323, 0.012562009505927563, 0.054016053676605225, -0.029613643884658813, 0.09580892324447632, -0.1541726142168045, -0.251838356256485, -0.10876281559467316, -0.011096834205091, -0.04577619582414627, -0.04750620573759079, 0.03738558292388916, 0.06511420756578445, -0.09829308837652206, 0.026720821857452393, 0.05873297527432442, 0.08005636930465698, -0.04080342873930931, -0.07101918011903763, 0.19448548555374146, -0.006242736242711544, -0.23498816788196564, -0.018641013652086258, 0.16482874751091003, 0.3042115569114685, 0.20118144154548645, 0.0708770751953125, -0.006659278646111488, 0.005768325179815292, 0.16507072746753693, -0.35033538937568665, 0.026908546686172485, 0.1448596566915512, 0.08297105878591537, 0.06263141334056854, 0.10095669329166412, -0.1398974508047104, -0.020331971347332, 0.1964837610721588, -0.11973413825035095, 0.09358593076467514, -0.0235733725130558, -0.18059802055358887, 0.05679384991526604, -0.16032809019088745, 0.25554221868515015, 0.06035055220127106, -0.20534640550613403, -0.1449281871318817, 0.22805091738700867, -0.22331352531909943, -0.10171815752983093, 0.16024714708328247, -0.09024148434400558, -0.170063316822052, -0.29843536019325256, 0.02949555218219757, 0.4444381892681122, 0.1785125881433487, -0.07318572700023651, 0.03964059054851532, -0.047658439725637436, -0.027662508189678192, -0.04030371084809303, 0.19302617013454437, -0.04843132197856903, 0.01112456526607275, -0.10473498702049255, -0.03882213681936264, 0.2946229577064514, 0.016152871772646904, -0.014903819188475609, 0.30220770835876465, 0.034320488572120667, 0.012122409418225288, 0.013536911457777023, 0.05498052015900612, -0.096601203083992, -0.06823094189167023, -0.09793213754892349, 0.0317145511507988, -0.07365083694458008, -0.12244517356157303, 0.015425516292452812, 0.09464512765407562, -0.16614902019500732, 0.17782986164093018, -0.10450132191181183, 0.03275790065526962, -0.09498069435358047, 0.007045523263514042, -0.07625728845596313, 0.02288825623691082, 0.15425346791744232, -0.3327190577983856, 0.08659214526414871, 0.16370128095149994, 0.054970938712358475, 0.13188257813453674, 0.06503897160291672, 0.07107458263635635, -0.009437423199415207, -0.06689681857824326, -0.14091216027736664, -0.09261825680732727, 0.03998735919594765, -0.16761742532253265, 0.08294444531202316, 0.07896844297647476])]
    ),
    new faceapi.LabeledFaceDescriptors(
        'A',
        [new Float32Array([-0.09908320009708405, 0.07272256910800934, 0.039592765271663666, -0.06935856491327286, -0.14748552441596985, -0.03557930141687393, -0.008919567801058292, 0.020275479182600975, 0.15247048437595367, -0.016272999346256256, 0.1773674041032791, 0.04161202907562256, -0.2503996789455414, -0.04406176507472992, -0.06799063086509705, 0.1280154436826706, -0.1734951287508011, -0.15162040293216705, -0.06098869442939758, -0.09968192875385284, 0.07956206798553467, -0.025614622980356216, -0.02813471294939518, 0.07545321434736252, -0.13673317432403564, -0.2748188078403473, -0.07115163654088974, -0.11937255412340164, 0.09027445316314697, -0.1282457560300827, 0.027125025168061256, 0.0048300717025995255, -0.13241764903068542, -0.06286396086215973, 0.02461470291018486, 0.04638240858912468, -0.028675951063632965, -0.07261902838945389, 0.21791136264801025, 0.03307492285966873, -0.13553640246391296, 0.08069605380296707, 0.06400321424007416, 0.3017730712890625, 0.13449445366859436, 0.08716238290071487, 0.03341277688741684, 0.049396760761737823, 0.17056410014629364, -0.3117977976799011, 0.1122165247797966, 0.1393517404794693, 0.18279783427715302, 0.043823160231113434, 0.1452266275882721, -0.19904576241970062, -0.03844447061419487, 0.26061907410621643, -0.27804046869277954, 0.23435388505458832, -0.027249742299318314, -0.06093231588602066, -0.08408211916685104, -0.15310348570346832, 0.1741022765636444, 0.17274783551692963, -0.1812787801027298, -0.11156927049160004, 0.1941702663898468, -0.1315317451953888, -0.027522049844264984, 0.11514940112829208, -0.10857951641082764, -0.13780100643634796, -0.200227752327919, 0.08993102610111237, 0.3851899802684784, 0.17015494406223297, -0.1507294625043869, -0.08280400186777115, 0.0008926753653213382, 0.008344413712620735, -0.04055311903357506, 0.015834292396903038, -0.11095408350229263, -0.09339559078216553, -0.0844619944691658, -0.021014420315623283, 0.09856771677732468, 0.0694086030125618, -0.03750043362379074, 0.23100993037223816, -0.010371004231274128, 0.03229902684688568, -0.06591019779443741, 0.05321356654167175, -0.15469415485858917, -0.053956080228090286, -0.05608535557985306, -0.03601702302694321, 0.026700880378484726, -0.16228872537612915, -0.001868032617494464, 0.06518365442752838, -0.11230513453483582, 0.05216354504227638, -0.06664348393678665, 0.03839503973722458, -0.07035447657108307, 0.10084085911512375, -0.1198439672589302, 0.020512863993644714, 0.15304139256477356, -0.2795974016189575, 0.2750341594219208, 0.21905368566513062, -0.01158501859754324, 0.06143496185541153, 0.03645126521587372, -0.01154645811766386, 0.031890641897916794, -0.07740144431591034, -0.1207365170121193, -0.12095527350902557, 0.010712447576224804, -0.12470006197690964, 0.03440540283918381, 0.02170592173933983])]
    ),
    new faceapi.LabeledFaceDescriptors(
        'P',
        [new Float32Array([-0.18621034920215607, 0.058044180274009705, -0.06999475508928299, -0.0714893713593483, -0.1185579001903534, -0.015019958838820457, -0.07382925599813461, -0.12151752412319183, 0.11764369904994965, -0.08551307767629623, 0.19254523515701294, 0.010769644752144814, -0.27151772379875183, -0.06982677429914474, 0.0069006383419036865, 0.07032335549592972, -0.2212621569633484, -0.09922504425048828, -0.04349163919687271, -0.028957528993487358, 0.06864404678344727, -0.017119785770773888, 0.030877158045768738, 0.08727171272039413, -0.11828384548425674, -0.2728060781955719, -0.12107086926698685, -0.09204909205436707, 0.06979148834943771, -0.06796115636825562, 0.019200216978788376, 0.04433320835232735, -0.10197212547063828, -0.005304349586367607, 0.026757188141345978, 0.16148346662521362, -0.1264183223247528, -0.022159643471240997, 0.2972840964794159, 0.009590260684490204, -0.13921326398849487, -0.07513994723558426, 0.008904839865863323, 0.2875579297542572, 0.22595134377479553, -0.008402321487665176, 0.03827397897839546, -0.06941159069538116, 0.12837018072605133, -0.2983894348144531, 0.06947661191225052, 0.26331210136413574, 0.13412709534168243, 0.13634136319160461, 0.015377525240182877, -0.18788014352321625, 0.0953240692615509, 0.16920869052410126, -0.2085714191198349, 0.07536371797323227, 0.09137577563524246, -0.11747461557388306, 0.020322322845458984, 0.030812645331025124, 0.21302562952041626, 0.12486369162797928, -0.14830784499645233, -0.15758627653121948, 0.12041463702917099, -0.20645804703235626, -0.06608268618583679, 0.123331718146801, -0.1635391116142273, -0.25696396827697754, -0.287717342376709, -0.012508023530244827, 0.39358869194984436, 0.21029888093471527, -0.08077037334442139, 0.017463017255067825, -0.11170583218336105, -0.09073173254728317, 0.09328897297382355, 0.057983167469501495, -0.13369406759738922, -0.03956228494644165, -0.10966743528842926, 0.058717552572488785, 0.17742545902729034, -0.004425864666700363, -0.020679200068116188, 0.2556030750274658, 0.09990537166595459, 0.09806394577026367, 0.07519429922103882, 0.04366540163755417, -0.006241468712687492, -0.05320289731025696, -0.07938399910926819, 0.029546301811933517, -0.047134023159742355, -0.18454518914222717, 0.08412642031908035, 0.0616791695356369, -0.16169090569019318, 0.2062453180551529, 0.026946499943733215, 0.05160364508628845, -0.076533742249012, -0.0664881095290184, -0.16286073625087738, 0.0094304159283638, 0.213333860039711, -0.2903100550174713, 0.1886100023984909, 0.20598754286766052, 0.09854038059711456, 0.16282479465007782, 0.1220291331410408, 0.06714576482772827, -0.04502083733677864, -0.08377537131309509, -0.1343006193637848, 0.03608391061425209, -0.00942342821508646, 0.005180276930332184, 0.05945461243391037, 0.04731316119432449])]
    ),

]

const CODE = new Map()
CODE.set("S", "2")
CODE.set("A", "8")
CODE.set("P", "3")
CODE.set("F", "6")

const NAMES_LEFT_TO_RIGHT = Array.from(CODE.keys())


const colors = {
    not_all: "217,70,86",
    incorrect_position: "241,177,19",
    correct_position: "98,217,0",
}

class DrawableDetection {
    // Persistent and smooth detections
    baseSize = 6
    baseWidth = 250

    detectionRadiusThreshold = 40
    smoothingFactor = 0.1

    constructor(name) {
        this.name = name
        this.x = 0
        this.y = 0
        this.sizeRem = 0.0
        this.opacity = 0.0

        this.targetX = 0
        this.targetY = 0
        this.targetSizeRem = 0.0
        this.targetOpacity = 0.0
    }

    update_detection_with_recognition(recognitionResults, names) {
        let recognitionForName = null
        for (let i = 0; i < recognitionResults.length; i++) {
            if (names[i] == this.name) {
                recognitionForName = recognitionResults[i]
                break
            }
        }
        if (recognitionForName === null) {
            this.targetOpacity = 0.0
        } else {
            this.targetOpacity = 1.0
            let coordinates = this._bboxToTargetValues(recognitionForName.detection.box)
            this.targetX = coordinates.x
            this.targetY = coordinates.y
            this.targetSizeRem = coordinates.sizeRem
        }
    }

    update_detection_without_recognition(detectionResults) {
        let minDistance = 1000000.0
        let probableNewCoordinates = null
        for (let detection of detectionResults) {
            const coordinates = this._bboxToTargetValues(detection.box)
            const distance = Math.sqrt(Math.pow(this.targetX - coordinates.x, 2) + Math.pow(this.targetY - coordinates.y, 2))
            if ((distance < minDistance) && (distance <= this.detectionRadiusThreshold)) {
                probableNewCoordinates = coordinates
                minDistance = distance
            }
        }
        if (probableNewCoordinates !== null) {
            this.targetX = probableNewCoordinates.x
            this.targetY = probableNewCoordinates.y
            this.targetSizeRem = probableNewCoordinates.sizeRem
        }
    }

    tick() {
        this.x = this._smoothValue(this.x, this.targetX)
        this.y = this._smoothValue(this.y, this.targetY)
        this.sizeRem = this._smoothValue(this.sizeRem, this.targetSizeRem)
        this.opacity = this._smoothValue(this.opacity, this.targetOpacity)
    }

    isDetected() {
        return this.opacity >= 0.05
    }

    _smoothValue(currentValue, targetValue) {
        return currentValue + (targetValue - currentValue) * this.smoothingFactor
    }

    _bboxToTargetValues(bbox) {
        return {
            x: bbox.x + bbox.width / 2,
            y: bbox.y - 50,
            sizeRem: this.baseSize * Math.pow(bbox.width / this.baseWidth, 2),
        }
    }
}

const drawables = GROUND_TRUTH.map(g => new DrawableDetection(g.label))

async function setupCamera(videoElement) {

    const changeCameraButton = document.getElementById('changeCamera')

    const constraints = {
        video: {}
    }

    async function getCameras() {
        const devices = await navigator.mediaDevices.enumerateDevices()
        const videoDevices = devices.filter(device => device.kind === 'videoinput')
        return videoDevices
    }

    async function bindVideo() {
        let currentCameraId = 0
        const availableCameras = await getCameras()
        changeCameraButton.onclick = () => {
            currentCameraId = (currentCameraId + 1) % availableCameras.length
            let updatedConstraints = {...constraints}
            updatedConstraints.video.deviceId = {exact: availableCameras[currentCameraId].deviceId}

            startStream(updatedConstraints)
        }
    }


    async function startStream(constraints) {
        const stream = await navigator.mediaDevices.getUserMedia(constraints)
        videoElement.srcObject = stream
    }

    await bindVideo()
    await startStream(constraints)
    console.log("Video started")

}

async function loadModels() {
    const baseUrl = `${window.location.href}/models`
    await faceapi.loadTinyFaceDetectorModel(baseUrl)
    await faceapi.loadFaceLandmarkTinyModel(baseUrl)
    await faceapi.loadFaceRecognitionModel(baseUrl)
}

function setupCanvas(inputElement, outputElement) {
    inputElement.width = inputElement.videoWidth
    inputElement.height = inputElement.videoHeight
    outputElement.width = inputElement.width
    outputElement.height = inputElement.height
}

async function setupFaceRecognition(inputElement, outputElement) {
    setupCanvas(inputElement, outputElement)

    let detectionCounter = 0
    const recognizeFacesEveryNInterations = 10
    const faceMatcher = new faceapi.FaceMatcher(GROUND_TRUTH, 0.6)

    async function detect(detection_options) {
        if (detectionCounter === 0) {
            let recognitions = await faceapi.detectAllFaces(inputElement, detection_options).withFaceLandmarks(true).withFaceDescriptors()
            const predictedNames = recognitions.map(r => faceMatcher.findBestMatch(r.descriptor).label)

            for (let drawable of drawables) {
                drawable.update_detection_with_recognition(recognitions, predictedNames)
            }
        } else {
            const detections = await faceapi.detectAllFaces(inputElement, detection_options)
            for (let drawable of drawables) {
                drawable.update_detection_without_recognition(detections)
            }
        }
        detectionCounter = (detectionCounter + 1) % recognizeFacesEveryNInterations
        for (let drawable of drawables) {
            drawable.tick()
        }

        drawDetections()

        setTimeout(() => detect(detection_options))
    }

    function drawDetections() {
        const ctx = outputElement.getContext('2d')
        ctx.clearRect(0, 0, outputElement.width, outputElement.height)

        const areAllNamesDetected = drawables.reduce((previous, currentDrawable) => previous && currentDrawable.isDetected(), true)
        const drawablesLeftToRight = drawables.sort((a, b) => a.x - b.x)

        for (let i = 0; i < drawablesLeftToRight.length; i++) {
            const drawable = drawablesLeftToRight[i]
            if (!drawable.isDetected())
                continue

            let color = colors.not_all
            if (areAllNamesDetected)
                color = drawable.name === NAMES_LEFT_TO_RIGHT[i] ? colors.correct_position : colors.incorrect_position

            ctx.font = `bold ${drawable.sizeRem}rem sans-serif`
            ctx.textAlign = "center"
            ctx.fillStyle = `rgba(${color}, ${drawable.opacity})`
            const text = CODE.get(drawable.name)
            ctx.fillText(text, drawable.x, drawable.y)
            ctx.strokeStyle = `rgba(0, 0, 0, ${drawable.opacity})`
            ctx.lineWidth = 3 * drawable.sizeRem / drawable.baseSize
            ctx.strokeText(text, drawable.x, drawable.y)
        }
    }

    const options = new faceapi.TinyFaceDetectorOptions({inputSize: 320, scoreThreshold: 0.5})
    detect(options)
    console.log("Detection started")
}

async function requestCameraPermission() {
    try {
        await navigator.mediaDevices.getUserMedia({video: true})
        return true;
    } catch (DomException) {
        document.getElementById("noCameraPermission").style.display = "block";
        return false;
    }
}

async function start(inputElement, outputElement) {
    if (!(await requestCameraPermission()))
        return;
    await setupCamera(inputElement)
    document.documentElement.requestFullscreen()
    document.getElementById("startContainer").style.display = "none"
    document.getElementById("main").style.visibility = "visible"
    setupFaceRecognition(inputElement, outputElement)  // On Android, the initial autoplay does not trigger a play event
}

async function main() {
    let inputElement = document.getElementById("myVideo")
    const outputElement = document.getElementById('overlay')
    await loadModels()
    const startButton = document.getElementById("startButton")
    startButton.addEventListener("click", () => start(inputElement, outputElement))
    inputElement.addEventListener('play', () => setupFaceRecognition(inputElement, outputElement))
    window.addEventListener("orientationchange",(event) => setupCanvas(inputElement, outputElement))
}

document.addEventListener("DOMContentLoaded", main)